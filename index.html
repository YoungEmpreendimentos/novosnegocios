<!DOCTYPE html>
<html>
<head>
<title>Dashboard de Novos Negócios</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  body {
    font-family: 'Inter', sans-serif;
  }
  .tab-content {
    display: none;
  }
  .tab-content.active {
    display: block;
  }
  .table-container {
    max-height: 400px;
    overflow-y: auto;
  }
  #loading-indicator {
    display: none; /* Escondido por padrão */
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 20px 40px;
    border-radius: 10px;
    z-index: 1000;
    font-size: 1.2em;
  }
</style>
</head>
<body class="bg-gray-100 text-gray-800">

<div id="loading-indicator">Carregando dados...</div>

<div class="container mx-auto p-4 md:p-8">
  <h1 class="text-3xl font-bold mb-6 text-gray-900">Dashboard de Novos Negócios</h1>

  <!-- Navegação por Abas -->
  <div class="border-b border-gray-200">
    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
      <button class="tab-link whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-indigo-500 text-indigo-600" onclick="openTab(event, 'DadosGerais')" id="defaultOpen">
        Dados Gerais
      </button>
      <button class="tab-link whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" onclick="openTab(event, 'FiltroRegiao')">
        Filtro por Região
      </button>
    </nav>
  </div>

  <!-- Conteúdo da Aba: Dados Gerais -->
  <div id="DadosGerais" class="tab-content mt-6">
    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
      <h3 class="text-lg font-semibold mb-4">Filtro por Período</h3>
      <div class="flex flex-wrap items-center gap-4">
        <div>
          <label for="startDate" class="block text-sm font-medium text-gray-700">Data de Início</label>
          <input type="date" id="startDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
        </div>
        <div>
          <label for="endDate" class="block text-sm font-medium text-gray-700">Data de Fim</label>
          <input type="date" id="endDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
        </div>
        <button onclick="filterTablesByDate()" class="self-end bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Filtrar</button>
         <button onclick="clearDateFilter()" class="self-end bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">Limpar Filtro</button>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Card: Atividades por Dia -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-xl font-semibold mb-4">Atividades Lançadas por Dia <span id="totalAtividades" class="text-indigo-600 font-bold"></span></h3>
            <div class="table-container">
                <table id="atividadesTable" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo de Contato</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantidade</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Card: Propostas por Mês -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-xl font-semibold mb-4">Propostas Apresentadas por Mês</h3>
            <div class="table-container">
                <table id="propostasTable" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mês</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantidade</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
        <!-- Card: Contagem de Reuniões por Imobiliária -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-xl font-semibold mb-4">Contagem de Reuniões por Imobiliária</h3>
            <div class="table-container">
                <table id="reunioesPorImobiliariaTable" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome da Imobiliária</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantidade</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Card: Reuniões com Imobiliárias -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-xl font-semibold mb-4">Detalhes das Reuniões Realizadas <span id="totalReunioes" class="text-indigo-600 font-bold"></span></h3>
            <div class="table-container">
                <div class="overflow-x-auto">
                    <table id="reunioesTable" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
  </div>

  <!-- Conteúdo da Aba: Filtro por Região -->
  <div id="FiltroRegiao" class="tab-content mt-6">
    <div class="bg-white p-6 rounded-lg shadow-md">
      <h3 class="text-lg font-semibold mb-4">Filtrar Glebas por Região</h3>
      <div>
          <label for="regiaoSelect" class="block text-sm font-medium text-gray-700">Selecione uma Região</label>
          <select id="regiaoSelect" onchange="filterGlebas()" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
          </select>
      </div>

      <h3 class="text-xl font-semibold mt-8 mb-4">Detalhes da Gleba</h3>
      <div class="overflow-x-auto table-container">
          <table id="glebasTable" class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
              </tbody>
          </table>
      </div>
    </div>
  </div>
</div>

<script>
    // URLs das planilhas publicadas como CSV
    const ATIVIDADES_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTaPNwPCuGyqUOuuyy1VbzxDvPVckinCg0DVwotQerHDIp88IflAPYYBfLgViqCNybvnxfNHkpyPBDK/pub?gid=1359873248&single=true&output=csv";
    const IMOBILIARIAS_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTaPNwPCuGyqUOuuyy1VbzxDvPVckinCg0DVwotQerHDIp88IflAPYYBfLgViqCNybvnxfNHkpyPBDK/pub?gid=172873143&single=true&output=csv";
    const PROPOSTAS_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTaPNwPCuGyqUOuuyy1VbzxDvPVckinCg0DVwotQerHDIp88IflAPYYBfLgViqCNybvnxfNHkpyPBDK/pub?gid=2032502494&single=true&output=csv";
    const GLEBAS_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTaPNwPCuGyqUOuuyy1VbzxDvPVckinCg0DVwotQerHDIp88IflAPYYBfLgViqCNybvnxfNHkpyPBDK/pub?gid=22338632&single=true&output=csv";

    let glebas_cols = []; // Armazenar cabeçalhos das glebas globalmente

    // Função para parsear texto CSV para um array de objetos
    function parseCSV(text) {
        const lines = text.trim().split('\n');
        const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
        const rows = [];
        for (let i = 1; i < lines.length; i++) {
            const values = lines[i].split(',');
            const row = {};
            for (let j = 0; j < headers.length; j++) {
                row[headers[j]] = (values[j] || '').trim().replace(/"/g, '');
            }
            rows.push(row);
        }
        return { headers, rows };
    }

    // Função principal para carregar e processar todos os dados
    async function loadDashboardData() {
        document.getElementById('loading-indicator').style.display = 'block';
        try {
            const [atividadesRes, imobiliariasRes, propostasRes, glebasRes] = await Promise.all([
                fetch(ATIVIDADES_URL),
                fetch(IMOBILIARIAS_URL),
                fetch(PROPOSTAS_URL),
                fetch(GLEBAS_URL)
            ]);

            const atividadesText = await atividadesRes.text();
            const imobiliariasText = await imobiliariasRes.text();
            const propostasText = await propostasRes.text();
            const glebasText = await glebasRes.text();

            // Processar Atividades
            const { rows: atividadesData } = parseCSV(atividadesText);
            const atividadesPorDia = atividadesData.reduce((acc, { Data, 'Tipo de Contato': tipoContato }) => {
                if (!Data || !tipoContato || tipoContato.trim() === '') return acc;
                const dateParts = Data.split('/');
                if (dateParts.length !== 3) return acc;
                const dateKey = `${dateParts[2]}-${dateParts[1].padStart(2, '0')}-${dateParts[0].padStart(2, '0')}`;
                const key = `${dateKey}|${tipoContato}`;
                if (!acc[key]) acc[key] = { Data: dateKey, 'Tipo de Contato': tipoContato, Quantidade: 0 };
                acc[key].Quantidade++;
                return acc;
            }, {});
            const totalAtividades = Object.values(atividadesPorDia).reduce((sum, item) => sum + item.Quantidade, 0);
            document.getElementById('totalAtividades').innerText = `(${totalAtividades})`;
            populateSimpleTable('atividadesTable', Object.values(atividadesPorDia), ['Data', 'Tipo de Contato', 'Quantidade']);

            // Processar Propostas
            const meses = ["janeiro", "fevereiro", "março", "abril", "maio", "junho", "julho", "agosto", "setembro", "outubro", "novembro", "dezembro"];
            const { rows: propostasData } = parseCSV(propostasText);
            const propostasPorMes = propostasData.reduce((acc, { Data }) => {
                if (!Data) return acc;
                const dateParts = Data.split('/');
                if (dateParts.length !== 3) return acc;
                const mesIndex = parseInt(dateParts[1], 10) - 1;
                const ano = dateParts[2];
                const sortKey = `${ano}-${dateParts[1].padStart(2, '0')}`;
                const displayMes = `${meses[mesIndex]}/${ano}`;

                if (!acc[sortKey]) {
                    acc[sortKey] = { Mês: displayMes, sortKey: sortKey, Quantidade: 0 };
                }
                acc[sortKey].Quantidade++;
                return acc;
            }, {});
            populateSimpleTable('propostasTable', Object.values(propostasPorMes), ['Mês', 'Quantidade']);

            // Processar Reuniões com Imobiliárias
            const { headers: reunioesHeaders, rows: imobiliariasData } = parseCSV(imobiliariasText);
            const reunioesRealizadas = imobiliariasData.filter(row => row.Status === 'Reunião realizada');
            
            // Atualizar total de reuniões no título
            document.getElementById('totalReunioes').innerText = `(${reunioesRealizadas.length})`;
            
            // Popular tabela de detalhes das reuniões
            populateTable('reunioesTable', reunioesHeaders, reunioesRealizadas.map(Object.values));
            
            // Processar e popular contagem de reuniões por imobiliária
            const reunioesPorNome = reunioesRealizadas.reduce((acc, { Nome }) => {
                if (!Nome) return acc;
                acc[Nome] = (acc[Nome] || 0) + 1;
                return acc;
            }, {});
            const reunioesPorNomeData = Object.entries(reunioesPorNome)
                .map(([nome, quantidade]) => ({ 'Nome da Imobiliária': nome, 'Quantidade': quantidade }))
                .sort((a, b) => b.Quantidade - a.Quantidade);
            populateSimpleTable('reunioesPorImobiliariaTable', reunioesPorNomeData, ['Nome da Imobiliária', 'Quantidade']);

            // Processar Glebas
            const { headers: glebasHeaders, rows: glebasData } = parseCSV(glebasText);
            glebas_cols = glebasHeaders; // Salva para uso no filtro
            const regioes = [...new Set(glebasData.map(row => row['Região']).filter(Boolean))];
            populateSelect('regiaoSelect', regioes);
            populateTable('glebasTable', glebasHeaders, glebasData.map(Object.values));

        } catch (error) {
            console.error("Erro ao carregar os dados do dashboard:", error);
            alert("Não foi possível carregar os dados das planilhas. Verifique sua conexão e se os links estão corretos.");
        } finally {
            document.getElementById('loading-indicator').style.display = 'none';
        }
    }

    function populateTable(tableId, headers, data) {
        const table = document.getElementById(tableId);
        const thead = table.querySelector('thead');
        const tbody = table.querySelector('tbody');
        
        thead.innerHTML = '';
        tbody.innerHTML = '';

        let headerRow = '<tr>';
        headers.forEach(header => {
            headerRow += `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${header}</th>`;
        });
        headerRow += '</tr>';
        thead.innerHTML = headerRow;

        data.forEach(rowData => {
            let row = '<tr class="data-row">';
            rowData.forEach(cellData => {
                row += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${cellData || ''}</td>`;
            });
            row += '</tr>';
            tbody.innerHTML += row;
        });
    }
    
    function populateSimpleTable(tableId, data, columns) {
        const tbody = document.getElementById(tableId).querySelector('tbody');
        tbody.innerHTML = '';
        data.sort((a, b) => {
            const keyA = a.sortKey || a.Data;
            const keyB = b.sortKey || b.Data;
            if (keyA < keyB) return -1;
            if (keyA > keyB) return 1;
            return 0;
        });
        data.forEach(item => {
            let row = '<tr class="data-row">';
            columns.forEach(col => {
                 row += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${item[col] || ''}</td>`;
            });
            row += '</tr>';
            tbody.innerHTML += row;
        });
    }

    function populateSelect(selectId, options) {
        const select = document.getElementById(selectId);
        select.innerHTML = '<option value="">Todas</option>';
        options.forEach(option => {
            if(option) {
                select.innerHTML += `<option value="${option}">${option}</option>`;
            }
        });
    }

    function openTab(evt, tabName) {
      let i, tabcontent, tablinks;
      tabcontent = document.getElementsByClassName("tab-content");
      for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].classList.remove("active");
      }
      tablinks = document.getElementsByClassName("tab-link");
      for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" border-indigo-500 text-indigo-600", " border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300");
      }
      document.getElementById(tabName).classList.add("active");
      evt.currentTarget.className = evt.currentTarget.className.replace(" border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300", " border-indigo-500 text-indigo-600");
    }

    function filterGlebas() {
      const select = document.getElementById("regiaoSelect");
      const filter = select.value.toUpperCase();
      const table = document.getElementById("glebasTable");
      const tr = table.querySelectorAll("tbody tr");
      const regiaoIndex = glebas_cols.findIndex(h => h.trim() === 'Região');

      tr.forEach(row => {
        const td = row.getElementsByTagName("td")[regiaoIndex];
        if (td) {
          const txtValue = td.textContent || td.innerText;
          if (filter === "" || txtValue.toUpperCase().indexOf(filter) > -1) {
            row.style.display = "";
          } else {
            row.style.display = "none";
          }
        }
      });
    }
    
    function filterTablesByDate() {
        let startDateInput = document.getElementById('startDate').value;
        let endDateInput = document.getElementById('endDate').value;

        if (!startDateInput || !endDateInput) return;

        let startDate = new Date(startDateInput + 'T00:00:00');
        let endDate = new Date(endDateInput + 'T23:59:59');

        filterTableByDate('atividadesTable', 0, startDate, endDate);
        filterTableByDate('propostasTable', 0, startDate, endDate, true);
    }
    
    function clearDateFilter() {
        document.getElementById('startDate').value = '';
        document.getElementById('endDate').value = '';
        
        showAllRows('atividadesTable');
        showAllRows('propostasTable');
    }

    function showAllRows(tableId) {
        const table = document.getElementById(tableId);
        const tr = table.querySelectorAll("tbody tr");
        tr.forEach(row => row.style.display = "");
    }

    function filterTableByDate(tableId, dateColumnIndex, startDate, endDate, isMonthYear = false) {
        const table = document.getElementById(tableId);
        const tr = table.querySelectorAll("tbody tr");
        const meses = ["janeiro", "fevereiro", "março", "abril", "maio", "junho", "julho", "agosto", "setembro", "outubro", "novembro", "dezembro"];

        tr.forEach(row => {
            const td = row.getElementsByTagName("td")[dateColumnIndex];
            if (td) {
                let cellDate;
                const dateText = td.textContent || td.innerText;
                if(isMonthYear) {
                    const [mesNome, ano] = dateText.split('/');
                    const mesIndex = meses.indexOf(mesNome.toLowerCase());
                    if(mesIndex > -1) {
                        cellDate = new Date(ano, mesIndex, 1);
                    }
                } else {
                    const dateParts = dateText.split('-');
                    cellDate = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
                }
                
                if (cellDate && cellDate >= startDate && cellDate <= endDate) {
                    row.style.display = "";
                } else {
                    row.style.display = "none";
                }
            }
        });
    }


    // Inicialização
    document.addEventListener('DOMContentLoaded', (event) => {
        loadDashboardData();
        document.getElementById("defaultOpen").click();
    });

</script>

</body>
</html>
