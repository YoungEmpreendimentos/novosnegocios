<!DOCTYPE html>
<html lang="pt-BR">
<head>
<title>Dashboard de Novos Negócios - Young Empreendimentos</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  body {
    font-family: 'Inter', sans-serif;
    background-color: #f8fafc; /* bg-slate-50 */
  }
  .tab-content {
    display: none;
  }
  .tab-content.active {
    display: block;
  }
  .table-container {
    max-height: 400px;
    overflow-y: auto;
  }
  #loading-indicator {
    display: none; /* Escondido por padrão */
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 20px 40px;
    border-radius: 10px;
    z-index: 1000;
    font-size: 1.2em;
  }
  /* Custom Accent Color - Young */
  .accent-bg { background-color: #f59e0b; } /* amber-500 */
  .accent-bg-hover:hover { background-color: #d97706; } /* amber-600 */
  .accent-text { color: #d97706; } /* amber-600 */
  .accent-border { border-color: #f59e0b; } /* amber-500 */
  .accent-ring-focus:focus { ring-color: #f59e0b; }
  .tab-link-active {
    border-color: #f59e0b; /* amber-500 */
    color: #020617; /* slate-900 */
  }
  /* Estilo para colunas compactas */
  .compact-column {
    max-width: 250px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  table {
    table-layout: auto;
    width: 100%;
  }
</style>
</head>
<body class="text-slate-800">

<div id="loading-indicator">Carregando dados...</div>

<div class="container mx-auto p-4 md:p-8">
  <header class="flex flex-col sm:flex-row items-center justify-between mb-8 pb-4 border-b border-slate-200">
    <h1 class="text-3xl font-bold text-slate-900">Dashboard de Novos Negócios</h1>
  </header>

  <!-- Navegação por Abas -->
  <div class="border-b border-slate-200">
    <nav class="-mb-px flex space-x-8" aria-label="Tabs">
      <button class="tab-link whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm tab-link-active" onclick="openTab(event, 'DadosGerais')" id="defaultOpen">
        Dados Gerais
      </button>
      <button class="tab-link whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300" onclick="openTab(event, 'FiltroRegiao')">
        Filtro por Região
      </button>
    </nav>
  </div>

  <!-- Conteúdo da Aba: Dados Gerais -->
  <div id="DadosGerais" class="tab-content mt-6">
    <div class="bg-white p-6 rounded-lg shadow-sm mb-6">
      <h3 class="text-lg font-semibold mb-4 text-slate-900">Filtro por Período</h3>
      <div class="flex flex-wrap items-center gap-4">
        <div>
          <label for="startDate" class="block text-sm font-medium text-slate-700">Data de Início</label>
          <input type="date" id="startDate" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-amber-500 focus:ring-amber-500 sm:text-sm">
        </div>
        <div>
          <label for="endDate" class="block text-sm font-medium text-slate-700">Data de Fim</label>
          <input type="date" id="endDate" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-amber-500 focus:ring-amber-500 sm:text-sm">
        </div>
        <button onclick="filterTablesByDate()" class="self-end accent-bg text-white px-4 py-2 rounded-md accent-bg-hover focus:outline-none focus:ring-2 focus:ring-offset-2 accent-ring-focus">Filtrar</button>
         <button onclick="clearDateFilter()" class="self-end bg-slate-600 text-white px-4 py-2 rounded-md hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-slate-500">Limpar Filtro</button>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Card: Gráfico de Atividades por Dia -->
        <div class="bg-white p-6 rounded-lg shadow-sm">
            <h3 class="text-xl font-semibold text-slate-900 mb-4">Atividades por Dia <span id="totalAtividades" class="accent-text font-bold"></span></h3>
            <canvas id="atividadesChartCanvas"></canvas>
        </div>
        
        <!-- Card: Detalhes da Proposta -->
        <div class="bg-white p-6 rounded-lg shadow-sm">
            <h3 class="text-xl font-semibold text-slate-900 mb-4">Detalhes da Proposta <span id="totalPropostas" class="accent-text font-bold"></span></h3>
            <div class="table-container">
                <table id="propostasDetalhadasTable" class="min-w-full divide-y divide-slate-200">
                    <thead class="bg-slate-50"></thead>
                    <tbody class="bg-white divide-y divide-slate-200"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Nova Linha para os Gráficos -->
    <div class="grid grid-cols-1 gap-6 mt-6">
        <!-- Card: Gráfico de Propostas por Mês -->
        <div class="bg-white p-6 rounded-lg shadow-sm">
            <h3 class="text-xl font-semibold mb-4 text-slate-900">Propostas por Mês</h3>
            <canvas id="propostasChartCanvas"></canvas>
        </div>
    </div>
  </div>

  <!-- Conteúdo da Aba: Filtro por Região -->
  <div id="FiltroRegiao" class="tab-content mt-6">
    <div class="bg-white p-6 rounded-lg shadow-sm">
      <h3 class="text-lg font-semibold mb-4 text-slate-900">Filtrar Glebas por Região</h3>
      <div>
          <label for="regiaoSelect" class="block text-sm font-medium text-slate-700">Selecione uma Região</label>
          <select id="regiaoSelect" onchange="filterGlebas()" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-amber-500 focus:border-amber-500 sm:text-sm rounded-md"></select>
      </div>

      <h3 class="text-xl font-semibold mt-8 mb-4 text-slate-900">Detalhes da Gleba <span id="glebasCount" class="accent-text font-bold"></span></h3>
      <div class="overflow-x-auto table-container">
          <table id="glebasTable" class="min-w-full divide-y divide-slate-200">
              <thead class="bg-slate-50"></thead>
              <tbody class="bg-white divide-y divide-slate-200"></tbody>
          </table>
      </div>
    </div>
  </div>
</div>

<script>
    // URLs das planilhas
    const ATIVIDADES_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTaPNwPCuGyqUOuuyy1VbzxDvPVckinCg0DVwotQerHDIp88IflAPYYBfLgViqCNybvnxfNHkpyPBDK/pub?gid=1359873248&single=true&output=csv";
    const PROPOSTAS_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTaPNwPCuGyqUOuuyy1VbzxDvPVckinCg0DVwotQerHDIp88IflAPYYBfLgViqCNybvnxfNHkpyPBDK/pub?gid=2032502494&single=true&output=csv";
    const GLEBAS_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTaPNwPCuGyqUOuuyy1VbzxDvPVckinCg0DVwotQerHDIp88IflAPYYBfLgViqCNybvnxfNHkpyPBDK/pub?gid=22338632&single=true&output=csv";

    let glebas_cols = [];
    let atividadesChart = null;
    let propostasChart = null;

    function parseCSV(text) {
        if (text.trim().toLowerCase().startsWith('<!doctype html')) {
             throw new Error('Um dos links da planilha parece estar inválido ou inacessível.');
        }
        const lines = text.trim().split('\n');
        const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
        const rows = [];
        for (let i = 1; i < lines.length; i++) {
            if (lines[i].trim() === '') continue;
            const values = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
            const row = {};
            for (let j = 0; j < headers.length; j++) {
                row[headers[j]] = (values[j] || '').trim().replace(/"/g, '');
            }
            rows.push(row);
        }
        return { headers, rows };
    }

    async function loadDashboardData() {
        document.getElementById('loading-indicator').style.display = 'block';
        try {
            const responses = await Promise.all([
                fetch(ATIVIDADES_URL), fetch(PROPOSTAS_URL), fetch(GLEBAS_URL)
            ]);
            
            for (const response of responses) {
                if (!response.ok) {
                    throw new Error(`Falha ao carregar dados de uma planilha: ${response.statusText}`);
                }
            }

            const [atividadesText, propostasText, glebasText] = await Promise.all(responses.map(res => res.text()));

            // Processar Atividades
            const { headers: atividadesHeaders, rows: atividadesRawData } = parseCSV(atividadesText);
            const atividadesData = atividadesRawData.filter(row => row[atividadesHeaders[0]] && !isNaN(parseInt(row[atividadesHeaders[0]], 10)));
            const atividadesPorDia = atividadesData.reduce((acc, row) => {
                const data = row['Data'];
                const tipoContato = row['Tipo de Contato'];
                if (!data || !tipoContato || tipoContato.trim() === '') return acc;
                const dateParts = data.split('/');
                if (dateParts.length !== 3) return acc;
                const dateKey = `${dateParts[2]}-${dateParts[1].padStart(2, '0')}-${dateParts[0].padStart(2, '0')}`;
                const key = `${dateKey}|${tipoContato}`;
                if (!acc[key]) acc[key] = { Data: dateKey, 'Tipo de Contato': tipoContato, Quantidade: 0 };
                acc[key].Quantidade++;
                return acc;
            }, {});
            const allAtividadesData = Object.values(atividadesPorDia);
            document.getElementById('totalAtividades').innerText = `(${allAtividadesData.reduce((sum, item) => sum + item.Quantidade, 0)})`;
            createAtividadesChart(allAtividadesData);

            // Processar Propostas
            const meses = ["janeiro", "fevereiro", "março", "abril", "maio", "junho", "julho", "agosto", "setembro", "outubro", "novembro", "dezembro"];
            const { headers: propostasHeaders, rows: propostasRawData } = parseCSV(propostasText);
            const propostasData = propostasRawData.filter(row => row[propostasHeaders[0]] && !isNaN(parseInt(row[propostasHeaders[0]], 10)));
            document.getElementById('totalPropostas').innerText = `(${propostasData.length})`;
            populatePropostasDetalhadas(propostasData, propostasHeaders);
            const propostasPorMes = propostasData.reduce((acc, row) => {
                const data = row['Data'];
                if (!data) return acc;
                const dateParts = data.split('/');
                if (dateParts.length !== 3) return acc;
                const mesIndex = parseInt(dateParts[1], 10) - 1;
                const ano = dateParts[2];
                if (isNaN(mesIndex) || mesIndex < 0 || mesIndex > 11 || isNaN(parseInt(ano))) return acc;
                const sortKey = `${ano}-${dateParts[1].padStart(2, '0')}`;
                const displayMes = `${meses[mesIndex]}/${ano}`;
                if (!acc[sortKey]) acc[sortKey] = { Mês: displayMes, sortKey: sortKey, Quantidade: 0 };
                acc[sortKey].Quantidade++;
                return acc;
            }, {});
            createPropostasChart(Object.values(propostasPorMes));

            // Processar Glebas
            const { headers: glebasHeaders, rows: glebasRawData } = parseCSV(glebasText);
            const glebasData = glebasRawData.filter(row => row[glebasHeaders[0]] && !isNaN(parseInt(row[glebasHeaders[0]], 10)));
            glebas_cols = glebasHeaders;
            document.getElementById('glebasCount').innerText = `(${glebasData.length})`;
            populateSelect('regiaoSelect', ["Metropolitana", "Litoral", "Santa Catarina"]);
            populateTable('glebasTable', glebasHeaders, glebasData.map(row => glebasHeaders.map(h => row[h])));

        } catch (error) {
            console.error("Erro ao carregar dados do dashboard:", error);
            const container = document.querySelector('.container');
            container.innerHTML = `
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative" role="alert">
                    <strong class="font-bold">Erro ao Carregar Dados!</strong>
                    <span class="block sm:inline">${error.message}</span>
                    <p class="mt-2">Por favor, verifique se os links das planilhas estão corretos e se elas foram <strong>publicadas na web como CSV</strong>. É necessário gerar um novo link de publicação se a planilha foi alterada.</p>
                </div>
            `;
        } finally {
            document.getElementById('loading-indicator').style.display = 'none';
        }
    }

    function populatePropostasDetalhadas(data, headers) {
        const table = document.getElementById('propostasDetalhadasTable');
        const cols = headers.filter(h => ['Data', 'Cidade', 'Apelido Gleba', 'Status'].includes(h));
        populateTable(table.id, cols, data.map(row => cols.map(c => row[c])));
    }

    function populateTable(tableId, headers, data) {
        const table = document.getElementById(tableId);
        const thead = table.querySelector('thead');
        const tbody = table.querySelector('tbody');
        thead.innerHTML = '';
        tbody.innerHTML = '';

        let headerRow = '<tr>';
        headers.forEach(header => headerRow += `<th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">${header}</th>`);
        thead.innerHTML = headerRow + '</tr>';

        const compactColumns = ['Observações', 'Tarefas', 'Comentários  (AUT)'];
        data.forEach(rowData => {
            let rowHtml = '<tr class="data-row">';
            rowData.forEach((cellData, index) => {
                const header = headers[index];
                const cleanCellData = cellData || '';
                let tdClass = 'px-6 py-4 text-sm text-slate-700';
                if (tableId === 'glebasTable' && compactColumns.includes(header)) {
                    tdClass += ' compact-column';
                    rowHtml += `<td class="${tdClass}" title="${cleanCellData.replace(/"/g, '&quot;')}">${cleanCellData}</td>`;
                } else {
                    rowHtml += `<td class="${tdClass}">${cleanCellData}</td>`;
                }
            });
            tbody.innerHTML += rowHtml + '</tr>';
        });
    }

    function populateSelect(selectId, options) {
        const select = document.getElementById(selectId);
        select.innerHTML = '<option value="">Todas</option>';
        options.forEach(option => select.innerHTML += `<option value="${option}">${option}</option>`);
    }

    function openTab(evt, tabName) {
      document.querySelectorAll(".tab-content").forEach(tc => tc.classList.remove("active"));
      document.querySelectorAll(".tab-link").forEach(tl => tl.className = tl.className.replace(" tab-link-active", " border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300"));
      document.getElementById(tabName).classList.add("active");
      evt.currentTarget.className = evt.currentTarget.className.replace(" border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300", " tab-link-active");
    }

    function filterGlebas() {
      const filter = document.getElementById("regiaoSelect").value.toUpperCase();
      const table = document.getElementById("glebasTable");
      const tr = table.querySelectorAll("tbody tr");
      const regiaoHeaderName = glebas_cols.find(h => h.trim().toLowerCase().startsWith('regi'));
      const regiaoIndex = glebas_cols.indexOf(regiaoHeaderName);
      let visibleCount = 0;

      tr.forEach(row => {
        const td = row.getElementsByTagName("td")[regiaoIndex];
        let isVisible = false;
        if (td) {
          const txtValue = td.textContent || td.innerText;
          if (filter === "" || txtValue.toUpperCase().indexOf(filter) > -1) {
            isVisible = true;
          }
        }
        row.style.display = isVisible ? "" : "none";
        if(isVisible) visibleCount++;
      });
      document.getElementById('glebasCount').innerText = `(${visibleCount})`;
    }
    
    function filterTablesByDate() {
        const startDate = new Date(document.getElementById('startDate').value + 'T00:00:00');
        const endDate = new Date(document.getElementById('endDate').value + 'T23:59:59');
        if (!document.getElementById('startDate').value || !document.getElementById('endDate').value) return;
        filterTableByDate('propostasDetalhadasTable', 0, startDate, endDate);
    }
    
    function clearDateFilter() {
        document.getElementById('startDate').value = '';
        document.getElementById('endDate').value = '';
        showAllRows('propostasDetalhadasTable');
    }

    function showAllRows(tableId) {
        document.querySelectorAll(`#${tableId} tbody tr`).forEach(row => row.style.display = "");
    }

    function filterTableByDate(tableId, dateColumnIndex, startDate, endDate) {
        const tr = document.querySelectorAll(`#${tableId} tbody tr`);
        tr.forEach(row => {
            const td = row.getElementsByTagName("td")[dateColumnIndex];
            if (td) {
                const dateText = td.textContent || td.innerText;
                const parts = dateText.split(dateText.includes('/') ? '/' : '-');
                const cellDate = dateText.includes('/') ? new Date(parts[2], parts[1] - 1, parts[0]) : new Date(parts[0], parts[1] - 1, parts[2]);
                row.style.display = (cellDate && cellDate >= startDate && cellDate <= endDate) ? "" : "none";
            }
        });
    }

    // --- Funções dos Gráficos ---
    function createChart(canvasId, chartInstance, type, data, options) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        if (chartInstance) chartInstance.destroy();
        return new Chart(ctx, { type, data, options });
    }

    const colorPalette = [
        'rgba(245, 158, 11, 0.7)', 'rgba(59, 130, 246, 0.7)', 'rgba(16, 185, 129, 0.7)', 
        'rgba(239, 68, 68, 0.7)', 'rgba(139, 92, 246, 0.7)', 'rgba(217, 70, 239, 0.7)'
    ];
    const borderColorPalette = [
        'rgba(217, 119, 6, 1)', 'rgba(37, 99, 235, 1)', 'rgba(5, 150, 105, 1)',
        'rgba(220, 38, 38, 1)', 'rgba(124, 58, 237, 1)', 'rgba(192, 38, 211, 1)'
    ];

    function createPropostasChart(data) {
        data.sort((a, b) => a.sortKey.localeCompare(b.sortKey));
        propostasChart = createChart('propostasChartCanvas', propostasChart, 'bar', {
            labels: data.map(d => d.Mês),
            datasets: [{
                label: 'Nº de Propostas',
                data: data.map(d => d.Quantidade),
                backgroundColor: colorPalette[0],
                borderColor: borderColorPalette[0],
                borderWidth: 1
            }]
        }, { responsive: true, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 }}}, plugins: { legend: { display: false }}});
    }

    function createAtividadesChart(data) {
        const labels = [...new Set(data.map(item => item.Data))].sort();
        const tiposDeContato = [...new Set(data.map(item => item['Tipo de Contato']))];
        
        const datasets = tiposDeContato.map((tipo, index) => ({
            label: tipo,
            data: labels.map(label => {
                const found = data.find(d => d.Data === label && d['Tipo de Contato'] === tipo);
                return found ? found.Quantidade : 0;
            }),
            backgroundColor: colorPalette[index % colorPalette.length],
            borderColor: borderColorPalette[index % borderColorPalette.length],
            borderWidth: 1
        }));

        atividadesChart = createChart('atividadesChartCanvas', atividadesChart, 'bar', {
            labels: labels,
            datasets: datasets
        }, { 
            responsive: true, 
            scales: { 
                x: { stacked: true },
                y: { stacked: true, beginAtZero: true, ticks: { stepSize: 1 }}
            }, 
            plugins: { 
                legend: { display: true, position: 'top' }
            }
        });
    }

    // Inicialização
    document.addEventListener('DOMContentLoaded', () => {
        loadDashboardData();
        document.getElementById("defaultOpen").click();
    });

</script>

</body>
</html>

